<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Madagascar Fady Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>

  <style>
    body { margin:0; padding:0; }
    #map { height: 100vh; }
    #searchBox {
      position: absolute;
      top: 10px; left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      background: white;
      padding: 5px 10px;
      border-radius: 5px;
      box-shadow: 0 0 5px rgba(0,0,0,0.3);
    }
  </style>
</head>
<body>

<div id="searchBox">
  <input type="text" id="searchInput" placeholder="Search location in Madagascar">
  <button id="searchBtn">Go</button>
</div>

<div id="map"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

<!-- Firebase SDK (compat for simple migration) -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

<script>
  // ======= Firebase Config & Initialization =======
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_PROJECT_ID.appspot.com",
    messagingSenderId: "YOUR_SENDER_ID",
    appId: "YOUR_APP_ID"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // ======= Initialize Leaflet Map (Madagascar-only) =======
  const madagascarBounds = [
    [-25.6, 43.2], // SW
    [-11.5, 50.5]  // NE
  ];

  const map = L.map('map', {
    maxBounds: madagascarBounds,
    maxBoundsViscosity: 1.0,
    minZoom: 5,
    maxZoom: 12
  }).setView([-18.7669, 46.8691], 6);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors',
  }).addTo(map);

  // ======= Drawing Controls =======
  const drawnItems = new L.FeatureGroup();
  map.addLayer(drawnItems);

  const drawControl = new L.Control.Draw({
    draw: {
      polygon: true,
      rectangle: true,
      marker: true,
      circle: false,
      circlemarker: false,
      polyline: false
    },
    edit: {
      featureGroup: drawnItems
    }
  });
  map.addControl(drawControl);

  // ======= Helper: bind click/delete to a single layer =======
  function attachLayerHandlers(layer) {
    layer.on('click', async function() {
      if (confirm("Remove this Fady?")) {
        drawnItems.removeLayer(layer);
        if (layer._docId) {
          try { await db.collection("fady").doc(layer._docId).delete(); }
          catch (e) { console.error("Delete failed", e); }
        }
      }
    });
  }

  // ======= Handle New Shapes (create) =======
  map.on(L.Draw.Event.CREATED, async function (event) {
    const layer = event.layer;
    const fadyDescription = prompt("Enter the Fady for this area:");
    if (!fadyDescription) return;

    layer.bindPopup(`<strong>Fady:</strong> ${fadyDescription}`);
    drawnItems.addLayer(layer);

    // Convert to GeoJSON Feature and ensure properties
    const feature = layer.toGeoJSON();
    feature.properties = feature.properties || {};
    feature.properties.fady = fadyDescription;

    try {
      const docRef = await db.collection("fady").add(feature);
      layer._docId = docRef.id; // attach Firestore id to the layer
      console.log("Fady saved to Firestore with id", docRef.id);
    } catch (error) {
      console.error("Error saving fady:", error);
    }

    attachLayerHandlers(layer);
  });

  // ======= Handle Edit (update) =======
  map.on(L.Draw.Event.EDITED, async function(e) {
    const layers = e.layers;
    layers.eachLayer(async function(l) {
      if (!l._docId) return;
      const feat = l.toGeoJSON();
      feat.properties = feat.properties || {};
      // Preserve existing fady if present
      // (if text edit allowed, you'd update properties.fady separately)
      try {
        await db.collection("fady").doc(l._docId).set(feat);
        console.log("Updated fady", l._docId);
      } catch (err) {
        console.error("Failed to update fady:", err);
      }
    });
  });

  // ======= Handle Delete from edit toolbar (bulk delete) =======
  map.on(L.Draw.Event.DELETED, async function(e) {
    const layers = e.layers;
    layers.eachLayer(async function(l) {
      if (l._docId) {
        try {
          await db.collection("fady").doc(l._docId).delete();
          console.log("Deleted fady", l._docId);
        } catch (err) {
          console.error("Failed to delete fady:", err);
        }
      }
    });
  });

  // ======= Load Existing Fady from Firestore =======
  async function loadFady() {
    try {
      const snapshot = await db.collection("fady").get();
      snapshot.forEach(doc => {
        const feature = doc.data(); // stored GeoJSON Feature
        // Add to map preserving properties and doc id
        const layerGroup = L.geoJSON(feature, {
          onEachFeature: function (feature, l) {
            l.bindPopup(`<strong>Fady:</strong> ${feature.properties?.fady || ''}`);
            l._docId = doc.id;
            attachLayerHandlers(l);
          }
        });
        drawnItems.addLayer(layerGroup);
      });
    } catch (err) {
      console.error("Error loading fady:", err);
    }
  }
  loadFady();

  // ======= Search Box Functionality (Nominatim) =======
  document.getElementById('searchBtn').addEventListener('click', async function() {
    const q = document.getElementById('searchInput').value.trim();
    if (!q) return;
    const query = q + " Madagascar";
    const url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(query)}`;
    try {
      const response = await fetch(url);
      const results = await response.json();
      if (results.length > 0) {
        const lat = parseFloat(results[0].lat);
        const lon = parseFloat(results[0].lon);
        map.setView([lat, lon], 10);
      } else {
        alert("Location not found.");
      }
    } catch (err) {
      console.error("Search failed", err);
      alert("Search failed.");
    }
  });

</script>

</body>
</html>