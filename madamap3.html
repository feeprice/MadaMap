<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Madagascar Fady Map - Minimal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>

  <style>
    html, body { margin:0; padding:0; width:100%; height:100%; }
    #map { width:100%; height:600px; }
    #searchBox {
      position:absolute;
      top:10px; left:50%;
      transform:translateX(-50%);
      z-index:1000;
      background:white;
      padding:5px 10px;
      border-radius:5px;
      box-shadow:0 0 5px rgba(0,0,0,0.3);
    }
  </style>
</head>
<body>

<div id="searchBox">
  <input type="text" id="searchInput" placeholder="Search location in Madagascar">
  <button id="searchBtn">Go</button>
</div>

<div id="map"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

<script>
  // ===== 1️⃣ Initialize Firebase =====
  const firebaseConfig = {
    apiKey: "AIzaSyAzazHrR1MZycLSVFaf3SJWbioZRaqhm7U",
    authDomain: "mada-map-cc473.firebaseapp.com",
    projectId: "mada-map-cc473",
    storageBucket: "mada-map-cc473.firebasestorage.app",
    messagingSenderId: "575563718533",
    appId: "1:575563718533:web:3df319306689f753102eec"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // ===== 2️⃣ Initialize Map =====
  const madagascarBounds = [[-25.6, 43.2], [-11.5, 50.5]];
  const map = L.map('map', {
    maxBounds: madagascarBounds,
    maxBoundsViscosity: 1.0,
    minZoom: 5,
    maxZoom: 12
  }).setView([-18.7669, 46.8691], 6);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  const drawnItems = new L.FeatureGroup();
  map.addLayer(drawnItems);

  const drawControl = new L.Control.Draw({
    draw: { polygon:true, rectangle:true, marker:true, circle:false, polyline:false },
    edit: { featureGroup: drawnItems }
  });
  map.addControl(drawControl);

  // ===== 3️⃣ Handle new shapes =====
  map.on(L.Draw.Event.CREATED, async function(event){
    const layer = event.layer;
    const description = prompt("Enter Fady description:");
    if(!description) return;

    layer.bindPopup(`<strong>Fady:</strong> ${description}`);
    drawnItems.addLayer(layer);

    // Convert GeoJSON to string for Firestore (flatten Point coordinates)
    let geojson = layer.toGeoJSON();
    if(geojson.geometry.type === "Point"){
      geojson.geometry.coordinates = { lng: geojson.geometry.coordinates[0], lat: geojson.geometry.coordinates[1] };
    }
    const geojsonStr = JSON.stringify(geojson);

    try {
      const docRef = await db.collection("fady").add({ geojson: geojsonStr, fady: description });
      console.log("Fady saved with ID:", docRef.id);

      layer.on('click', async function(){
        if(confirm("Remove this Fady?")){
          drawnItems.removeLayer(layer);
          await db.collection("fady").doc(docRef.id).delete();
        }
      });
    } catch(err){
      console.error("Error saving Fady:", err);
    }
  });

  // ===== 4️⃣ Load existing Fady =====
  async function loadFady(){
    const snapshot = await db.collection("fady").get();
    snapshot.forEach(doc=>{
      const data = doc.data();
      let geojson = JSON.parse(data.geojson);

      // Restore Point coordinates
      if(geojson.geometry.type === "Point"){
        geojson.geometry.coordinates = [geojson.geometry.coordinates.lng, geojson.geometry.coordinates.lat];
      }

      const layer = L.geoJSON(geojson).bindPopup(`<strong>Fady:</strong> ${data.fady}`);
      layer.eachLayer(l=>{
        l.on('click', async function(){
          if(confirm("Remove this Fady?")){
            drawnItems.removeLayer(l);
            await db.collection("fady").doc(doc.id).delete();
          }
        });
      });
      drawnItems.addLayer(layer);
    });
  }
  loadFady();

  // ===== 5️⃣ Search box =====
  document.getElementById('searchBtn').addEventListener('click', async function(){
    const query = document.getElementById('searchInput').value + " Madagascar";
    const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`;
    const response = await fetch(url);
    const results = await response.json();
    if(results.length>0){
      map.setView([parseFloat(results[0].lat), parseFloat(results[0].lon)], 10);
    } else {
      alert("Location not found.");
    }
  });
</script>

</body>
</html>



